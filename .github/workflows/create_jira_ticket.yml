name: Create Jira Ticket for Bugs
'on':
  issues:
    types:
      - labeled
permissions:
  issues: read
  contents: read
jobs:
  create-jira:
    if: github.event.label.name == 'bug'
    runs-on: ubuntu-latest
    steps:
      - name: Create Jira Issue
        env:
          ISSUE_TITLE: '${{ github.event.issue.title }}'
          ISSUE_URL: '${{ github.event.issue.html_url }}'
          ISSUE_BODY: '${{ github.event.issue.body }}'
          JIRA_PROJECT_KEY: '${{ secrets.JIRA_PROJECT_KEY }}'
          JIRA_LABELS: '${{ secrets.JIRA_LABELS }}'
          JIRA_USERNAME: '${{ secrets.JIRA_USERNAME }}'
          JIRA_API_TOKEN: '${{ secrets.JIRA_API_TOKEN }}'
          JIRA_BASE_URL: '${{ secrets.JIRA_BASE_URL }}'
        run: |
          set -euo pipefail

          # Prepare fields
          SUMMARY="[GitHub][iOS SDK] $ISSUE_TITLE"

          # Build JSON payload in Atlassian Document Format (ADF)
          JSON_PAYLOAD=$(jq -n \
            --arg summary "$SUMMARY" \
            --arg url "$ISSUE_URL" \
            --arg body "$ISSUE_BODY" \
            --arg project "$JIRA_PROJECT_KEY" \
            --argjson labels "$JIRA_LABELS" \
            '{
              fields: {
                project: { key: $project },
                summary: $summary,
                description: {
                  type: "doc",
                  version: 1,
                  content: [
                    {
                      type: "paragraph",
                      content: [
                        {
                          type: "text",
                          text: "GitHub issue: ",
                          marks: []
                        },
                        {
                          type: "text",
                          text: $url,
                          marks: [{ type: "link", attrs: { href: $url } }]
                        }
                      ]
                    },
                    {
                      type: "paragraph",
                      content: [
                        { type: "text", text: $body }
                      ]
                    }
                  ]
                },
                issuetype: { name: "Bug" },
                labels: $labels
              }
            }'
          )

          # Create Jira issue
          curl -sS -u "$JIRA_USERNAME:$JIRA_API_TOKEN" -X POST \
            -H "Content-Type: application/json" \
            --data "$JSON_PAYLOAD" \
            "$JIRA_BASE_URL/rest/api/3/issue"
